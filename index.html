<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ุฏุนูุฉ ูุญุถูุฑ</title>
    <style>
      body {
        font-family: "Segoe UI", Roboto, "Noto Naskh Arabic", Arial;
        background: #f3f4f6;
        margin: 0;
        padding: 40px;
        text-align: center;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 28px;
        max-width: 360px;
        margin: auto;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
      }
      .buttons {
        display: flex;
        justify-content: center;
        gap: 14px;
        margin-top: 18px;
      }
      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        text-decoration: none;
        font-size: 16px;
      }
      .confirm {
        background: #2f855a;
      }
      .decline {
        background: #d9534f;
      }
      #qrcode-container {
        display: flex;
        flex-direction: column;
        gap: 25px;
        align-items: center;
        margin-top: 25px;
      }
      #qrcode-container > div {
        width: 120px;
        height: 120px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>
  <body>
    <div class="card" id="inviteCard">
      <h2>ูุฑุญุจุงู <span id="guestSpan"></span></h2>
      <p>ูุชุดุฑู ุจุฏุนูุชูู ูุญุถูุฑ ุญูู ุฒูุงู (ุงุณู ุงูุนุฑูุณ) ู (ุงุณู ุงูุนุฑูุณ)</p>
      <p>๐ ุงูููุช: 8 PM</p>
      <p>๐ ุงูููู: ุงูุฌูุนุฉ</p>
      <p>๐ ุงูููุงู: ููุฏู ุฑูุฌูุณู</p>
      <p>ุนุฏุฏ ุงูุฏุนูุงุช: <span id="countSpan">-</span></p>

      <div class="buttons">
        <a id="confirmBtn" class="btn confirm" href="javascript:void(0)"
          >ุชุฃููุฏ</a
        >
        <a id="declineBtn" class="btn decline" href="javascript:void(0)"
          >ุงุนุชุฐุงุฑ</a
        >
      </div>
    </div>

    <div id="barcodeSection" style="display: none">
      <h2 id="msg"></h2>
      <div id="qrcode-container"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const guestParam =
          new URLSearchParams(window.location.search).get("guest") || "";
        const webAppUrl =
          "https://script.google.com/macros/s/AKfycbz9JFpr5ikzlPa5W1hrODoLKbgUOOiLXFtF6bP6-wogdWn_xIfPcs1MWo0o2S0ZzG-9/exec";

        let guestName = guestParam;
        let guestID = guestParam;
        let guestCount = 1;

        // ุฌูุจ ุงูุจูุงูุงุช ูู Web App
        try {
          const res = await fetch(
            webAppUrl + "?guest=" + encodeURIComponent(guestParam)
          );
          const json = await res.json();
          guestName = json.guest || guestName;
          guestCount = parseInt(json.count, 10) || 1;
          guestID = json.id || guestParam; // ID ูู Web App
        } catch (err) {
          console.warn(
            "ูู ูุชู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุดูุชุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุงูุชุฑุงุถู",
            err
          );
        }

        document.getElementById("guestSpan").textContent = guestName;
        document.getElementById("countSpan").textContent = guestCount;

        const inviteCard = document.getElementById("inviteCard");
        const barcodeSection = document.getElementById("barcodeSection");
        const msg = document.getElementById("msg");
        const container = document.getElementById("qrcode-container");

        function updateStatus(guest, status) {
          fetch(
            webAppUrl + `?guest=${encodeURIComponent(guest)}&status=${status}`,
            { method: "POST" }
          ).catch((err) => console.error(err));
        }

        function generateBarcodes(id, count) {
          container.innerHTML = "";
          for (let i = 1; i <= count; i++) {
            const div = document.createElement("div");
            container.appendChild(div);
            new QRCode(div, {
              text: id + "-" + i, // <--- ุงูุจุงุฑููุฏ ID-ุฑูู
              width: 120,
              height: 120,
              correctLevel: QRCode.CorrectLevel.L,
            });
            const label = document.createElement("span");
            label.textContent = i; // ุงูุฑูู
            label.style.marginTop = "8px";
            label.style.fontSize = "14px";
            label.style.fontWeight = "bold";
            div.appendChild(label);
          }
        }

        try {
          const res = await fetch(
            webAppUrl + "?guest=" + encodeURIComponent(guestParam)
          );
          const json = await res.json();
          guestName = json.guest || guestName;
          guestCount = Number(json.count) || 1;
          guestID = json.id || guestParam;
          const status = json.status || "";

          if (status === "confirmed") {
            inviteCard.style.display = "none";
            barcodeSection.style.display = "block";
            msg.innerText =
              "ุจุงุฑููุฏ ุงูุฏุฎูู ุงูุฎุงุต ุจูุ ูุถูุงู ุชุฃูุฏ ูู ุญูุธ ุงูุตูุฑุฉ ูู ุฌูุงุฒู ูุฅุจุฑุงุฒูุง ุนูุฏ ุงูุฏุฎูู";
            generateBarcodes(guestID, guestCount);
          } else if (status === "declined") {
            inviteCard.style.display = "none";
            barcodeSection.style.display = "block";
            msg.innerText = "ูุฃุณู ูุนุฏู ุชูููู ูู ุงูุญุถูุฑ";
          }
        } catch (err) {
          console.warn(
            "ูู ูุชู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุดูุชุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุงูุชุฑุงุถู",
            err
          );
        }

        document.getElementById("confirmBtn").onclick = function () {
          updateStatus(guestName, "confirmed");
          localStorage.setItem("status_" + guestName, "confirmed");
          inviteCard.style.display = "none";
          barcodeSection.style.display = "block";
          msg.innerText =
            "ุจุงุฑููุฏ ุงูุฏุฎูู ุงูุฎุงุต ุจูุ ูุถูุงู ุชุฃูุฏ ูู ุญูุธ ุงูุตูุฑุฉ ูู ุฌูุงุฒู ูุฅุจุฑุงุฒูุง ุนูุฏ ุงูุฏุฎูู";
          generateBarcodes(guestID, guestCount);
        };

        document.getElementById("declineBtn").onclick = function () {
          updateStatus(guestName, "declined");
          localStorage.setItem("status_" + guestName, "declined");
          inviteCard.style.display = "none";
          barcodeSection.style.display = "block";
          msg.innerText = "ูุฃุณู ูุนุฏู ุชูููู ูู ุงูุญุถูุฑ";
          container.innerHTML = "";
        };
      });
    </script>
  </body>
</html>
